<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DreamWeaver AI</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#16213e" />
  <link rel="icon" href="./icon-192x192.png" />
  <style>
    :root{
      --bg1:#0f1530; --bg2:#16213e; --accent:#e94560; --card:rgba(255,255,255,0.04);
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, Roboto, system-ui, Arial;min-height:100vh;color:#fff;background:linear-gradient(135deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
    header{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;background:rgba(0,0,0,0.12)}
    .logo{font-weight:700;letter-spacing:0.6px}
    main{max-width:980px;margin:18px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:920px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.45)}
    h1,h2{margin:0 0 8px 0}
    textarea,select,input[type="file"]{width:100%;padding:10px;border-radius:8px;border:0;background:var(--card);color:#fff;margin-top:8px}
    button{background:var(--accent);border:0;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
    .buttons{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    nav.bottom{position:fixed;left:0;right:0;bottom:0;background:#0f3460;padding:8px 10px;display:flex;justify-content:space-around}
    nav.bottom button{background:none;border:0;color:rgba(233,69,96,0.9);font-weight:700}
    nav.bottom button.active{color:#fff;border-top:3px solid var(--accent);padding-top:6px}
    .spinner{display:inline-block;width:16px;height:16px;border:3px solid rgba(255,255,255,0.12);border-top-color:#fff;border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .result img{max-width:100%;border-radius:8px;margin-top:8px}
    .small{font-size:13px;color:rgba(255,255,255,0.8)}
    footer{padding:12px;text-align:center;font-size:13px}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:84px;background:#111;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
  </style>
</head>
<body>
  <header>
    <div class="logo">ğŸŒ™ DreamWeaver AI</div>
    <div class="small">RÃ¼ya tabiri Â· Fal Â· Tarot Â· GÃ¶rselleÅŸtirme</div>
  </header>

  <main>
    <div class="grid">
      <div>
        <section id="home" class="card" aria-labelledby="homeTitle">
          <h1 id="homeTitle">Merhaba â€” RÃ¼yanÄ± keÅŸfet</h1>
          <p class="small">GerÃ§ek AI tabirleri iÃ§in premium deÄŸil â€” backend ile Ã§alÄ±ÅŸÄ±r. Ã–nce dene, sonra devreye al.</p>

          <div style="margin-top:12px">
            <button onclick="show('dream')">RÃ¼ya Tabiri</button>
            <button onclick="show('fortune')" class="secondary">Fal & Tarot</button>
            <button onclick="show('gallery')" class="secondary">Galeri</button>
          </div>

          <div style="margin-top:12px" class="card">
            <h3>GÃ¼nlÃ¼k Ä°lham</h3>
            <p id="motivationText">KÃ¼Ã§Ã¼k adÄ±mlar, bÃ¼yÃ¼k sonuÃ§lar getirir â€” bugÃ¼n birine yardÄ±m et.</p>
            <div class="buttons"><button onclick="getMotivation()">Yeni</button><button onclick="speakMotivation()" class="secondary">Sesli Oku</button></div>
          </div>
        </section>

        <section id="dream" class="card" hidden>
          <h2>RÃ¼ya Tabiri</h2>
          <label for="zodiac">BurÃ§</label>
          <select id="zodiac" aria-label="BurÃ§ seÃ§imi">
            <option value="koÃ§">KoÃ§</option><option value="boÄŸa">BoÄŸa</option><option value="ikizler">Ä°kizler</option>
            <option value="yengeÃ§">YengeÃ§</option><option value="aslan">Aslan</option><option value="baÅŸak">BaÅŸak</option>
            <option value="terazi">Terazi</option><option value="akrep">Akrep</option><option value="yay">Yay</option>
            <option value="oÄŸlak">OÄŸlak</option><option value="kova">Kova</option><option value="balÄ±k">BalÄ±k</option>
          </select>

          <label for="dreamText" class="small">RÃ¼yanÄ± detaylÄ± yaz (ne kadar detay o kadar iyi)</label>
          <textarea id="dreamText" rows="6" placeholder="RÃ¼yanÄ±zÄ± anlatÄ±n..."></textarea>

          <div class="buttons">
            <button id="analyzeDreamBtn" onclick="analyzeDream()">AI ile Tabir Et</button>
            <button onclick="visualizeDream()" class="secondary">GÃ¶rselleÅŸtir</button>
          </div>

          <div id="dreamResult" class="result" aria-live="polite"></div>
        </section>

        <section id="fortune" class="card" hidden>
          <h2>Fal & Tarot</h2>
          <label for="fortuneType">TÃ¼r</label>
          <select id="fortuneType"><option value="kahve">Kahve</option><option value="el">El</option><option value="tarot">Tarot</option></select>

          <label class="small">Resim (kahve/el iÃ§in)</label>
          <input id="fortuneImage" type="file" accept="image/*">

          <div class="buttons"><button onclick="analyzeFortune()">Fal Bak</button><button onclick="analyzeFortune(true)" class="secondary">Rastgele & HÄ±zlÄ±</button></div>

          <div id="fortuneResult" class="result" aria-live="polite"></div>
        </section>

        <section id="gallery" class="card" hidden>
          <h2>Galeri</h2>
          <div id="galleryGrid" class="small">HenÃ¼z kayÄ±t yok.</div>
        </section>
      </div>

      <aside>
        <div class="card">
          <h3>HÄ±zlÄ± Ayarlar</h3>
          <div class="small">PWA / offline destekli. Backend varsa gerÃ§ek AI Ã§alÄ±ÅŸÄ±r.</div>
          <div style="margin-top:8px" class="buttons">
            <button onclick="clearData()" class="secondary">Verileri Temizle</button>
            <button id="installBtn" style="display:none">UygulamayÄ± YÃ¼kle</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Son KayÄ±tlar</h4>
          <div id="recentList" class="small"></div>
        </div>
      </aside>
    </div>
  </main>

  <nav class="bottom" role="navigation">
    <button onclick="show('home')" class="active">Ana</button>
    <button onclick="show('dream')">RÃ¼ya</button>
    <button onclick="show('fortune')">Fal</button>
    <button onclick="show('gallery')">Galeri</button>
  </nav>

  <footer>Â© 2025 DreamWeaver AI</footer>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
    // ---------- configuration ----------
    const API_BASE = ''; // boÅŸ bÄ±rak => aynÄ± origin (production). GeliÅŸtirme iÃ§in Ã¶rn 'http://localhost:3000'

    // ---------- state ----------
    const state = {
      isPremium: localStorage.getItem('isPremium') === 'true',
      dreams: JSON.parse(localStorage.getItem('dreams') || '[]')
    };

    // ---------- UI helpers ----------
    function show(id){
      document.querySelectorAll('main section').forEach(s => s.hidden = true);
      const el = document.getElementById(id);
      if(el) el.hidden = false;
      document.querySelectorAll('nav.bottom button').forEach(b => b.classList.remove('active'));
      const btn = Array.from(document.querySelectorAll('nav.bottom button')).find(b => b.textContent.toLowerCase() === id);
      if(btn) btn.classList.add('active');
      if(id === 'gallery') renderGallery();
      if(id === 'home') getMotivation();
    }

    function toast(msg, timeout=3000){
      const t = document.getElementById('toast'); t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display = 'none', timeout);
    }

    // ---------- Motivation ----------
    const motivations = [
      "BugÃ¼n kÃ¼Ã§Ã¼k bir yardÄ±m bÃ¼yÃ¼k fark yaratÄ±r.",
      "Kendine karÅŸÄ± nazik ol; ilerleme sabÄ±r ister.",
      "Yeni fikirler iÃ§in aÃ§Ä±k ol â€” beklenmedik kapÄ±lar aÃ§Ä±labilir.",
      "Hata yapmak Ã¶ÄŸrenmektir; pes etme!"
    ];
    function getMotivation(){ document.getElementById('motivationText').textContent = motivations[Math.floor(Math.random()*motivations.length)]; }
    function speakMotivation(){ if('speechSynthesis' in window){ const u=new SpeechSynthesisUtterance(document.getElementById('motivationText').textContent); u.lang='tr-TR'; speechSynthesis.speak(u);} else alert('Sesli okuma desteklenmiyor.'); }

    // ---------- Local fallback generator (Ã§eÅŸitlilik iÃ§in) ----------
    function localDreamAnalysis(text, zodiac, isPremium){
      const seeds = [
        `Bu rÃ¼ya, iÃ§sel bir deÄŸiÅŸimi iÅŸaret ediyor. ${zodiac} burcuna Ã¶zgÃ¼ olarak duygularÄ±nÄ± dengelemen gerekebilir.`,
        `RÃ¼yanda gÃ¶rÃ¼len semboller yeni bir baÅŸlangÄ±ca iÅŸaret ediyor. ${zodiac} iÃ§in Ã¶zellikle kariyer/iliÅŸki alanÄ±nda fÄ±rsatlar var.`,
        `Ãœst Ã¼ste gelen imgeler, geÃ§miÅŸin Ã§Ã¶zÃ¼lmemiÅŸ meselelerine dair uyarÄ± olabilir. ${zodiac} olarak sabÄ±rlÄ± ol.`,
        `RÃ¼yanda yol/gÃ¶kyÃ¼zÃ¼/su varsa â€” duygusal bir temizlenme ve yeni adÄ±mlar yakÄ±ndÄ±r. ${zodiac} enerjisiyle uyumlu hareket et.`
      ];
      let base = seeds[Math.floor(Math.random()*seeds.length)];
      if(isPremium) base += " (Premium detay: Ã–nÃ¼mÃ¼zdeki 3 haftaya dikkat; uygulamada geÃ§miÅŸ analizlerini kullan.)";
      // kÄ±sa varyasyon
      const extra = ["SaÄŸlÄ±k: dikkatli ol.","Ä°liÅŸkiler: aÃ§Ä±k iletiÅŸim kur.","Kariyer: yeni bir teklif olabilir."];
      base += " " + extra[Math.floor(Math.random()*extra.length)];
      return base;
    }

    // ---------- helpers: fetch with timeout ----------
    async function fetchWithTimeout(path, opts={}, timeout=12000){
      const controller = new AbortController();
      const id = setTimeout(()=>controller.abort(), timeout);
      try{
        const res = await fetch((API_BASE||'') + path, {...opts, signal:controller.signal});
        clearTimeout(id);
        return res;
      }catch(e){ clearTimeout(id); throw e; }
    }

    // ---------- analyzeDream ----------
    async function analyzeDream(){
      const text = document.getElementById('dreamText').value.trim();
      const zodiac = document.getElementById('zodiac').value;
      if(!text) return alert('LÃ¼tfen rÃ¼yanÄ± yaz.');
      const btn = document.getElementById('analyzeDreamBtn');
      btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Tabir hazÄ±rlanÄ±yor...';
      const out = document.getElementById('dreamResult');
      out.innerHTML = '';
      try{
        const res = await fetchWithTimeout('/api/analyzeDream', {
          method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text,zodiac,isPremium:state.isPremium})
        }, 14000);
        if(!res.ok) throw new Error('backend hata');
        const j = await res.json();
        out.innerHTML = `<h3>Tabir</h3><p>${j.analysis}</p>`;
        saveDream({text,analysis:j.analysis,image:null});
      }catch(err){
        // fallback local
        const analysis = localDreamAnalysis(text,zodiac,state.isPremium);
        out.innerHTML = `<h3>Tabir (Ã§evrimdÄ±ÅŸÄ±/fallback)</h3><p>${analysis}</p>`;
        saveDream({text,analysis,image:null});
        toast('Backend baÄŸlanamadÄ± â€” yerel tabir gÃ¶sterildi', 4000);
      } finally { btn.disabled = false; btn.innerHTML = 'AI ile Tabir Et'; }
    }

    // ---------- visualizeDream (backend image or placeholder) ----------
    async function visualizeDream(){
      const text = document.getElementById('dreamText').value.trim();
      if(!text) return alert('RÃ¼yanÄ± yaz.');
      const out = document.getElementById('dreamResult');
      out.innerHTML = '<div class="spinner"></div> GÃ¶rsel hazÄ±rlanÄ±yor...';
      try{
        const res = await fetchWithTimeout('/api/visualize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,isPremium:state.isPremium})},20000);
        if(!res.ok) throw new Error('visualize error');
        const j = await res.json();
        out.innerHTML += `<img src="${j.imageUrl}" alt="RÃ¼ya GÃ¶rseli">`;
        saveDream({text,analysis:null,image:j.imageUrl});
      }catch(e){
        const placeholder = 'https://via.placeholder.com/640x360?text=Dream+Image';
        out.innerHTML = `<img src="${placeholder}" alt="placeholder">`;
        saveDream({text,analysis:null,image:placeholder});
        toast('GÃ¶rsel hizmeti kullanÄ±lamÄ±yor â€” placeholder gÃ¶sterildi',4000);
      }
    }

    // ---------- fortune (image -> base64 included) ----------
    function fileToBase64(file){
      return new Promise((res,rej)=>{
        const fr = new FileReader();
        fr.onload = e => res(e.target.result);
        fr.onerror = e => rej(e);
        fr.readAsDataURL(file);
      });
    }

    async function analyzeFortune(forceRandom=false){
      const type = document.getElementById('fortuneType').value;
      const file = document.getElementById('fortuneImage').files[0];
      const out = document.getElementById('fortuneResult');
      out.innerHTML = '<div class="spinner"></div> Fal hazÄ±rlanÄ±yor...';
      let imgData = null;
      try{
        if(file) imgData = await fileToBase64(file);
        const payload = { type, isPremium:state.isPremium, imageBase64: imgData, forceRandom };
        const res = await fetchWithTimeout('/api/analyzeFortune',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)},14000);
        if(!res.ok) throw new Error('fortune backend');
        const j = await res.json();
        out.innerHTML = `<h3>${type.toUpperCase()}</h3><p>${j.comment}</p>` + (imgData ? `<img src="${imgData}" style="max-width:100%;border-radius:8px;margin-top:8px">` : '');
      }catch(e){
        // local fallback
        const pool = {
          kahve: ['Kahve falÄ±nda pozitif iÅŸaretler var.', 'YakÄ±nda kÃ¼Ã§Ã¼k bir sÃ¼rpriz bekleniyor.'],
          el: ['El falÄ±nda liderlik iÅŸareti.', 'SaÄŸlÄ±ÄŸa dikkat etmen gerekebilir.'],
          tarot: ['Tarot: dÃ¶nÃ¼ÅŸÃ¼m zamanÄ±.', 'Tarot: yeni bir denge bulunuyor.']
        };
        const comment = pool[type][Math.floor(Math.random()*pool[type].length)];
        out.innerHTML = `<h3>${type.toUpperCase()}</h3><p>${comment}</p>` + (imgData ? `<img src="${imgData}" style="max-width:100%;border-radius:8px;margin-top:8px">` : '');
        toast('Fal hizmeti yok â€” yerel yorum gÃ¶sterildi',3500);
      }
    }

    // ---------- save / gallery ----------
    function saveDream(item){
      item.date = new Date().toISOString();
      state.dreams.unshift(item);
      if(state.dreams.length > 200) state.dreams.pop();
      localStorage.setItem('dreams', JSON.stringify(state.dreams));
      renderRecent();
    }
    function renderGallery(){
      const g = document.getElementById('galleryGrid');
      if(!state.dreams.length) { g.innerHTML = 'HenÃ¼z kayÄ±t yok.'; return; }
      g.innerHTML = '';
      state.dreams.slice(0,24).forEach(d=>{
        const el = document.createElement('div'); el.className='small';
        el.innerHTML = `<div style="margin-bottom:6px"><strong>${new Date(d.date).toLocaleString('tr-TR')}</strong></div><div>${d.text ? d.text.slice(0,120) : ''}</div>` + (d.image ? `<div style="margin-top:6px"><img src="${d.image}" style="width:100%;border-radius:8px"></div>` : '');
        g.appendChild(el);
      });
    }
    function renderRecent(){
      const r = document.getElementById('recentList'); r.innerHTML='';
      state.dreams.slice(0,5).forEach(d=>{ const el = document.createElement('div'); el.className='small'; el.textContent = `${new Date(d.date).toLocaleString('tr-TR')} â€” ${d.text ? d.text.slice(0,40) : '(gÃ¶rsel)'}`; r.appendChild(el); });
    }

    function clearData(){ if(confirm('TÃ¼m kayÄ±tlar silinsin mi?')){ state.dreams=[]; localStorage.removeItem('dreams'); renderGallery(); renderRecent(); toast('Veriler silindi'); } }

    // PWA install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display='inline-block'; });
    document.getElementById('installBtn').addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; deferredPrompt = null; });

    // init
    (function(){ renderRecent(); const h = location.hash.replace('#',''); if(h) show(h); else show('home'); })();

    // register service worker
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').then(()=>console.log('SW ok')).catch(()=>console.warn('SW fail')); }
  </script>
</body>
</html>
